(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function e(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=e(r);fetch(r.href,i)}})();class l{constructor(...t){this._requiredKeys=t}beforeupdate(t,e){}update(t,e){}afterupdate(t,e){}getStyle(t,e="body"){const a=document.querySelector(e);return getComputedStyle(a).getPropertyValue(t)}}class v{constructor(){this._systems=[],this._entities=[],this._running=!1}_canUpdate(t,e){let a=!0;const r=Object.keys(e);return t.forEach(i=>{r.includes(i)||(a=!1)}),a}_tick(t){this._running&&(this._systems.forEach(e=>{e.beforeupdate(t,this),this._entities.filter(r=>this._canUpdate(e._requiredKeys,r)).forEach(r=>{e.update(t,r)}),e.afterupdate(t,this)}),requestAnimationFrame(e=>this._tick(e)))}start(){this._running=!0,requestAnimationFrame(t=>this._tick(t))}stop(){this._running=!1}toggle(){this._running?this.stop():this.start()}addSystem(t){this._systems.includes(t)||(this._systems.push(t),t._engine=this)}removeSystem(t){const e=this._systems.indexOf(t);e>=0&&this._systems.splice(e,1)}addEntity(t){this._entities.includes(t)||this._entities.push(t)}removeEntity(t){const e=this._entities.indexOf(t);e>=0&&this._entities.splice(e,1)}}const h=(s,t,e,a)=>{document.querySelector(s).addEventListener(t,a.bind(null,e))},y=s=>Math.PI/180*s,d=s=>Math.floor(Math.random()*s),m=(s,t)=>d(t-s)+s;class g extends Image{constructor(t,e="#000",a=1){super();const r=t.startsWith("./")?t:t.startsWith("/")?"."+t:"./"+t,i=e.startsWith("--")?getComputedStyle(document.querySelector("body")).getPropertyValue(e):e,n=new Image;n.onload=()=>{const u=Math.floor(n.height*a),p=Math.floor(n.width*a),_=new OffscreenCanvas(p,u),f=_.getContext("2d");f.fillStyle=i,f.fillRect(0,0,p,u),f.globalCompositeOperation="destination-in",f.drawImage(n,0,0,p,u),_.convertToBlob().then(w=>this.src=URL.createObjectURL(w))},n.src=r}}class b{set(t,e){return this[t]=e,this.dirty=!0,this}get(t){return this[t]}}class x{constructor(){this.entity=new b}register(...t){return t.forEach(e=>{e.startsWith("_")||Object.defineProperty(this.entity,e,{set:function(a){return this[`_${e}`]=a,this.dirty=!0,this},get:function(){return this[`_${e}`]},enumerable:!0})}),this}set(t,e){return this.register(t),this.entity.set(t,e),this}assign(t){const e=Object.keys(t);return this.register(...e),Object.assign(this.entity,t),this}build(){return this.entity}}class S extends l{constructor(t){super("x","y"),this._canvas=document.querySelector(t)}_outOfBounds(t){return t.x<0||t.y<0||t.x>this._canvas.width||t.y>this._canvas.height}_getDirection(t){return t>45&&t<=135?"e":t>135&&t<=225?"s":t>225&&t<=315?"w":"n"}_clamp(t){t.x<0?t.x=0:t.x>this._canvas.width&&(t.x=this._canvas.width),t.y<0?t.y=0:t.y>this._canvas.height&&(t.y=this._canvas.height)}update(t,e){if(this._outOfBounds(e))switch(e.boundry){case"wrap":case"torus":e.x=e.x<0?this._canvas.width-e.sprite.width:e.x,e.x=e.x>this._canvas.width+e.sprite.width?0:e.x,e.y=e.y<0?this._canvas.height:e.y,e.y=e.y>this._canvas.height+e.sprite.height?0:e.y;break;case"bounce":switch(this._getDirection(e.heading)){case"n":e.heading=m(45,315);break;case"e":e.heading=m(135,405)%360;break;case"s":e.heading=m(225,495)%360;break;case"w":e.heading=m(315,585)%360;break}this._clamp(e);break;default:e.dead=!0;break}}}class E extends l{constructor(){super("stardate")}update(t,e){t>e._next&&(e.stardate+=.1,e.missiondate-=.1,e._next=t+5e3)}}class k extends l{constructor(t){super("msg"),this.container=document.querySelector(t),this._msgs=[]}_createLine(t){const e=document.createElement("div");return e.innerText=t,e}update(t,e){if(e.msg){this._msgs.unshift(e.msg),delete e.msg;const a=this._msgs.map(this._createLine);this.container.replaceChildren(...a)}}}class O extends l{constructor(){super("x","y","speed","heading")}update(t,e){e.speed>0&&(e.x+=e.speed*Math.cos(Math.PI/180*(e.heading-90)),e.y+=e.speed*Math.sin(Math.PI/180*(e.heading-90)))}}class C extends l{constructor(){super("dead")}update(t,e){e.dead&&this._engine.removeEntity(e)}}class P extends l{constructor(){super("dirty")}_refresh(t,e){document.getElementsByName(t).forEach(r=>{const i=r.getAttribute("data-suffix"),n=r.getAttribute("data-fixed"),u=n?e.toFixed(n):e,p=i?`&nbsp;${i}`:"";r.innerHTML=`${u}${p}`})}update(t,e){Object.keys(e).filter(r=>!r.startsWith("_")).forEach(r=>{this._refresh(r,e[r])}),delete e.dirty}}class M extends l{constructor(t){super("x","y","sprite"),this._canvas=document.querySelector(t)}beforeupdate(){this._canvas.getContext("2d").clearRect(0,0,this._canvas.width,this._canvas.height),this._canvas.width=this._canvas.offsetWidth,this._canvas.height=this._canvas.offsetHeight}update(t,e){const a=this._canvas.getContext("2d");if(e.sprite){const{width:r,height:i}=e.sprite;if(a.save(),a.translate(e.x,e.y),a.rotate(y(e.heading)),a.drawImage(e.sprite,-r/2,-i/2,r,i),e.name||e.id){const n=e.name||e.id;a.rotate(y(-e.heading)),a.font="12px Arial",a.fillStyle=this.getStyle("--on-backdrop");const u=a.measureText(n);a.fillText(n,-r/2-u.width/8,-i/2-8)}a.restore()}}}const I=s=>{s.player.torpedo?(s.player.torpedo--,s.engine.addEntity({x:s.player.x,y:s.player.y,heading:s.player.heading,speed:s.player.speed+2,yield:10,sprite:new g("/assets/torpedo.png","--accent",.4)})):s.player.msg="SULU: Torpedo tubes are empty!"},L=s=>{s.player.phasar&&(s.player.energy>=s.player.phasar?(s.player.energy-=s.player.phasar,s.engine.addEntity({x:s.player.x,y:s.player.y,heading:s.player.heading,speed:6,yield:10,sprite:new g("/assets/phasar.png","--accent",.25)})):s.player.msg="SCOTT: Insufficient energy for phasars!")},c=new v;c.addSystem(new E);c.addSystem(new k(".comms .content"));c.addSystem(new C);c.addSystem(new P);c.addSystem(new O);c.addSystem(new S(".sci canvas"));c.addSystem(new M(".sci canvas"));c.start();c.addEntity(new x().set("_next",0).set("stardate",2395.2).set("missiondate",30).build());const o=new x().assign({name:"NCC-1701",energy:3e3,shield:0,phasar:0,torpedo:10,heading:d(360),speed:d(4)+1,boundry:"wrap",x:d(1024),y:d(1024),sprite:new g("/assets/starship.png","--accent")}).build();o.msg="SPOCK: Captain on deck.";c.addEntity(o);h("#rs-btn","click",o,s=>s.heading-=5);h("#rd-btn","click",o,s=>s.heading+=5);h("#impulse-btn","input",o,(s,t)=>s.speed=Number.parseFloat(t.target.value));h("#phasar-btn","input",o,(s,t)=>s.phasar=Number.parseFloat(t.target.value));h("#shield-btn","input",o,(s,t)=>s.shield=Number.parseFloat(t.target.value));h("#fire-btn","click",{player:o,engine:c},L);h("#launch-btn","click",{player:o,engine:c},I);h("#freeze-btn","click",null,()=>c.toggle());c.addEntity({name:"IKS M'Char",energy:200,shield:0,heading:d(360),speed:d(4)+1,boundry:"bounce",x:d(1024),y:d(1024),sprite:new g("/assets/klingon.png","--error",.7)});c.addEntity({name:"IKS Pagh",energy:200,shield:0,heading:d(360),speed:d(4)+1,boundry:"wrap",x:d(1024),y:d(1024),sprite:new g("/assets/klingon.png","--error",.7)});
