(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function e(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=e(r);fetch(r.href,i)}})();class l{constructor(...s){this._requiredKeys=s}beforeupdate(s,e){}update(s,e){}afterupdate(s,e){}getStyle(s,e="body"){const a=document.querySelector(e);return getComputedStyle(a).getPropertyValue(s)}}class x{constructor(){this._systems=[],this._entities=[],this._running=!1}_canUpdate(s,e){let a=!0;const r=Object.keys(e);return s.forEach(i=>{r.includes(i)||(a=!1)}),a}_tick(s){this._running&&(this._systems.forEach(e=>{e.beforeupdate(s,this),this._entities.filter(r=>this._canUpdate(e._requiredKeys,r)).forEach(r=>{e.update(s,r)}),e.afterupdate(s,this)}),requestAnimationFrame(e=>this._tick(e)))}start(){this._running=!0,requestAnimationFrame(s=>this._tick(s))}stop(){this._running=!1}toggle(){this._running?this.stop():this.start()}addSystem(s){this._systems.includes(s)||(this._systems.push(s),s._engine=this)}removeSystem(s){const e=this._systems.indexOf(s);e>=0&&this._systems.splice(e,1)}addEntity(s){this._entities.includes(s)||this._entities.push(s)}removeEntity(s){const e=this._entities.indexOf(s);e>=0&&this._entities.splice(e,1)}}const h=(t,s,e,a)=>{document.querySelector(t).addEventListener(s,a.bind(null,e))},_=t=>Math.PI/180*t,d=t=>Math.floor(Math.random()*t),f=(t,s)=>d(s-t)+t;class g extends Image{constructor(s,e="#000",a=1){super(),this.assetSrc=s,this.color=e,this.scale=a;const r=new Image;r.onload=()=>{const i=Math.floor(r.height*this.scale),c=Math.floor(r.width*this.scale),u=new OffscreenCanvas(c,i),p=u.getContext("2d");p.fillStyle=this.color,p.fillRect(0,0,c,i),p.globalCompositeOperation="destination-in",p.drawImage(r,0,0,c,i),u.convertToBlob().then(y=>this.src=URL.createObjectURL(y))},r.src=this.assetSrc}get color(){return this._color.startsWith("--")?getComputedStyle(document.querySelector("body")).getPropertyValue(this._color):this._color}set color(s){this._color=s}get assetSrc(){return this._src.startsWith("./")?this._src:this._src.startsWith("/")?"."+this._src:"./"+this._src}set assetSrc(s){this._src=s}}class w{set(s,e){return this[s]=e,this.dirty=!0,this}get(s){return this[s]}}class m{constructor(){this.entity=new w}register(...s){return s.forEach(e=>{e.startsWith("_")||Object.defineProperty(this.entity,e,{set:function(a){return this[`_${e}`]=a,this.dirty=!0,this},get:function(){return this[`_${e}`]},enumerable:!0})}),this}set(s,e){return this.register(s),this.entity.set(s,e),this}assign(s){const e=Object.keys(s);return this.register(...e),Object.assign(this.entity,s),this}build(){return this.entity}}class v extends l{constructor(s){super("x","y"),this._canvas=document.querySelector(s)}_outOfBounds(s){return s.x<0||s.y<0||s.x>this._canvas.width||s.y>this._canvas.height}_getDirection(s){return s>45&&s<=135?"e":s>135&&s<=225?"s":s>225&&s<=315?"w":"n"}_clamp(s){s.x<0?s.x=0:s.x>this._canvas.width&&(s.x=this._canvas.width),s.y<0?s.y=0:s.y>this._canvas.height&&(s.y=this._canvas.height)}update(s,e){if(this._outOfBounds(e))switch(e.boundry){case"wrap":case"torus":e.x=e.x<0?this._canvas.width-e.sprite.width:e.x,e.x=e.x>this._canvas.width+e.sprite.width?0:e.x,e.y=e.y<0?this._canvas.height:e.y,e.y=e.y>this._canvas.height+e.sprite.height?0:e.y;break;case"bounce":switch(this._getDirection(e.heading)){case"n":e.heading=f(45,315);break;case"e":e.heading=f(135,405)%360;break;case"s":e.heading=f(225,495)%360;break;case"w":e.heading=f(315,585)%360;break}this._clamp(e);break;default:e.dead=!0;break}}}class b extends l{constructor(){super("stardate")}update(s,e){s>e._next&&(e.stardate+=.1,e.missiondate-=.1,e._next=s+5e3)}}class S extends l{constructor(s){super("msg"),this.container=document.querySelector(s),this._msgs=[]}_createLine(s){const e=document.createElement("div");return e.innerText=s,e}update(s,e){if(e.msg){this._msgs.unshift(e.msg),delete e.msg;const a=this._msgs.map(this._createLine);this.container.replaceChildren(...a)}}}class E extends l{constructor(){super("x","y","speed","heading")}update(s,e){e.speed>0&&(e.x+=e.speed*Math.cos(Math.PI/180*(e.heading-90)),e.y+=e.speed*Math.sin(Math.PI/180*(e.heading-90)))}}class k extends l{constructor(){super("dead")}update(s,e){e.dead&&this._engine.removeEntity(e)}}class O extends l{constructor(){super("dirty")}_refresh(s,e){document.getElementsByName(s).forEach(r=>{const i=r.getAttribute("data-suffix"),c=r.getAttribute("data-fixed"),u=c?e.toFixed(c):e,p=i?`&nbsp;${i}`:"";r.innerHTML=`${u}${p}`})}update(s,e){Object.keys(e).filter(r=>!r.startsWith("_")).forEach(r=>{this._refresh(r,e[r])}),delete e.dirty}}class C extends l{constructor(s){super("x","y","sprite"),this._canvas=document.querySelector(s)}beforeupdate(){this._canvas.getContext("2d").clearRect(0,0,this._canvas.width,this._canvas.height),this._canvas.width=this._canvas.offsetWidth,this._canvas.height=this._canvas.offsetHeight}update(s,e){const a=this._canvas.getContext("2d");if(e.sprite){const{width:r,height:i}=e.sprite;if(a.save(),a.translate(e.x,e.y),a.rotate(_(e.heading)),a.drawImage(e.sprite,-r/2,-i/2,r,i),e.name||e.id){const c=e.name||e.id;a.rotate(_(-e.heading)),a.font="12px Arial",a.fillStyle=this.getStyle("--on-backdrop");const u=a.measureText(c);a.fillText(c,-r/2-u.width/8,-i/2-8)}a.restore()}}}const P=t=>{t.player.torpedo?(t.player.torpedo--,t.engine.addEntity({x:t.player.x,y:t.player.y,heading:t.player.heading,speed:t.player.speed+2,yield:10,sprite:new g("/assets/torpedo.png","--accent",.4)})):t.player.msg="SULU: Torpedo tubes are empty!"},M=t=>{t.player.phasar&&(t.player.energy>=t.player.phasar?(t.player.energy-=t.player.phasar,t.engine.addEntity({x:t.player.x,y:t.player.y,heading:t.player.heading,speed:6,yield:10,sprite:new g("/assets/phasar.png","--accent",.25)})):t.player.msg="SCOTT: Insufficient energy for phasars!")},n=new x;n.addSystem(new b);n.addSystem(new S(".comms .content"));n.addSystem(new k);n.addSystem(new O);n.addSystem(new E);n.addSystem(new v(".sci canvas"));n.addSystem(new C(".sci canvas"));n.start();n.addEntity(new m().set("_next",0).set("stardate",2395.2).set("missiondate",30).build());const o=new m().assign({name:"NCC-1701",energy:3e3,shield:0,phasar:0,torpedo:10,heading:d(360),speed:d(4)+1,boundry:"wrap",x:d(1024),y:d(1024),sprite:new g("/assets/starship.png","--accent")}).build();o.msg="SPOCK: Captain on deck.";n.addEntity(o);h("#rs-btn","click",o,t=>t.heading-=5);h("#rd-btn","click",o,t=>t.heading+=5);h("#impulse-btn","input",o,(t,s)=>t.speed=Number.parseFloat(s.target.value));h("#phasar-btn","input",o,(t,s)=>t.phasar=Number.parseFloat(s.target.value));h("#shield-btn","input",o,(t,s)=>t.shield=Number.parseFloat(s.target.value));h("#fire-btn","click",{player:o,engine:n},M);h("#launch-btn","click",{player:o,engine:n},P);h("#freeze-btn","click",null,()=>n.toggle());n.addEntity({name:"IKS M'Char",energy:200,shield:0,heading:d(360),speed:d(4)+1,boundry:"bounce",x:d(1024),y:d(1024),sprite:new g("/assets/klingon.png","--error",.7)});n.addEntity({name:"IKS Pagh",energy:200,shield:0,heading:d(360),speed:d(4)+1,boundry:"wrap",x:d(1024),y:d(1024),sprite:new g("/assets/klingon.png","--error",.7)});
